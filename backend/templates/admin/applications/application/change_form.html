{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrastyle %}
{{ block.super }}
<style>
.application-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}
.application-summary__item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px 12px;
}
.application-summary__label {
    display: block;
    font-size: 12px;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-bottom: 4px;
}
.application-summary__value {
    font-size: 14px;
    font-weight: 600;
    color: #212529;
    word-break: break-word;
}
.application-extra {
    margin-top: 32px;
    display: grid;
    gap: 24px;
    clear: both;
}
.application-section h2 {
    margin-top: 0;
    margin-bottom: 12px;
    font-size: 18px;
}
.application-comment-form {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 16px;
}
.application-comment-form .fieldBox {
    margin-bottom: 12px;
}
.application-comment-form__actions {
    display: flex;
    align-items: center;
    gap: 12px;
}
.application-comment-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 12px;
}
.application-comment-list__item {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px 14px;
    background: #fff;
}
.application-comment-list__item--urgent {
    border-color: #dc3545;
    box-shadow: 0 0 0 1px rgba(220, 53, 69, 0.15);
}
.application-comment-list__item .meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 6px;
}
.application-comment-list__item .meta .tag {
    background: #dc3545;
    color: #fff;
    border-radius: 999px;
    padding: 2px 8px;
    font-weight: 600;
}
.application-comment-list__item .text {
    white-space: pre-wrap;
    font-size: 14px;
    color: #212529;
}
.application-comment-list__empty {
    color: #6c757d;
    font-style: italic;
}
.application-status-timeline {
    list-style: none;
    margin: 0;
    padding: 0;
    border-left: 2px solid #dee2e6;
}
.application-status-timeline__item {
    margin-left: 16px;
    padding-left: 16px;
    position: relative;
    margin-bottom: 16px;
}
.application-status-timeline__item:before {
    content: "";
    position: absolute;
    left: -18px;
    top: 4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #0d6efd;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px #0d6efd;
}
.application-status-timeline__time {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 4px;
}
.application-status-timeline__transition {
    font-weight: 600;
    color: #212529;
}
.application-status-timeline__user {
    color: #495057;
    font-size: 13px;
}
.application-downloads {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 16px;
}
.application-downloads .button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 14px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    border: 1px solid transparent;
}
.application-downloads .button-primary {
    background: #0d6efd;
    border-color: #0d6efd;
    color: #fff;
}
.application-downloads .button-primary:hover {
    background: #0b5ed7;
    border-color: #0a58ca;
}
.application-downloads .button-outline {
    background: #fff;
    border-color: #0d6efd;
    color: #0d6efd;
}
.application-downloads .button-outline:hover {
    background: #e7f1ff;
}
.application-downloads .button-disabled {
    background: #e9ecef;
    border-color: #ced4da;
    color: #6c757d;
    cursor: not-allowed;
}
.application-documents {
    display: grid;
    gap: 16px;
}
.application-document-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 14px 16px;
    background: #fff;
}
.application-document-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 12px;
}
.application-document-card__title {
    font-weight: 600;
    font-size: 15px;
    margin: 0;
}
.application-document-card__filename {
    font-size: 12px;
    color: #6c757d;
    margin-top: 4px;
}
.application-document-card__status {
    padding: 2px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}
.status-available {
    background: #198754;
    color: #fff;
}
.status-uploaded {
    background: #0d6efd;
    color: #fff;
}
.status-pending {
    background: #fd7e14;
    color: #fff;
}
.status-rejected {
    background: #dc3545;
    color: #fff;
}
.status-missing {
    background: #adb5bd;
    color: #fff;
}
.status-info {
    background: #6c757d;
    color: #fff;
}
.application-document-card__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}
.application-document-card__actions a {
    font-size: 12px;
}
.application-document-card__form {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}
.application-document-card__form input[type="file"] {
    flex: 1 1 220px;
}
.application-document-card__form input[type="text"] {
    flex: 1 1 200px;
    min-width: 160px;
}
.application-document-card__form .button {
    padding: 6px 14px;
}
.application-document-card--new {
    background: #f8f9fa;
}
</style>
{% endblock %}

{% block object-tools-items %}
  {{ block.super }}
{% endblock %}

{% block form_top %}
  {% if summary_cards %}
    <div class="application-summary">
      {% for card in summary_cards %}
        <div class="application-summary__item">
          <span class="application-summary__label">{{ card.label }}</span>
          <span class="application-summary__value">{% if card.is_html %}{{ card.value|safe }}{% else %}{{ card.value|default:"—" }}{% endif %}</span>
        </div>
      {% endfor %}
    </div>
    {% if export_actions %}
      <div class="application-downloads">
        {% for action in export_actions %}
          {% if action.disabled %}
            <span class="button button-disabled">{{ action.label }}</span>
          {% elif forloop.first %}
            <a class="button button-primary" href="{{ action.url }}"{% if action.target %} target="{{ action.target }}"{% endif %}>{{ action.label }}</a>
          {% else %}
            <a class="button button-outline" href="{{ action.url }}"{% if action.target %} target="{{ action.target }}"{% endif %}>{{ action.label }}</a>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  {% endif %}
  {{ block.super }}
{% endblock %}

{% block content %}
  {{ block.super }}
  <div id="application-extra" class="application-extra">
    {% if documents_overview %}
      <section id="documents" class="application-section">
        <h2>Документы</h2>
        <div class="application-documents">
          {% for item in documents_overview.requirements %}
            <div class="application-document-card">
              <div class="application-document-card__header">
                <div>
                  <p class="application-document-card__title">{{ item.label }}</p>
                  {% if item.filename %}
                    <div class="application-document-card__filename">{{ item.filename }}</div>
                  {% endif %}
                </div>
                <span class="application-document-card__status {{ item.status_class }}">{{ item.status_label }}</span>
              </div>
              <div class="application-document-card__actions">
                {% if item.download_url %}
                  <a class="button" href="{{ item.download_url }}" target="_blank" rel="noopener">Скачать</a>
                {% endif %}
                {% if item.change_url %}
                  <a class="button" href="{{ item.change_url }}" target="_blank">Открыть карточку</a>
                {% endif %}
                {% if item.versions_url %}
                  <a class="button" href="{{ item.versions_url }}" target="_blank">Версии</a>
                {% endif %}
              </div>
              <form method="post" action="{{ documents_upload_url }}" enctype="multipart/form-data" class="application-document-card__form">
                {% csrf_token %}
                {% if item.requirement_id %}
                  <input type="hidden" name="requirement" value="{{ item.requirement_id }}">
                {% endif %}
                {% if item.document_id %}
                  <input type="hidden" name="document_id" value="{{ item.document_id }}">
                {% endif %}
                <input type="hidden" name="title" value="{{ item.label }}">
                <input type="file" name="document_file" required>
                <button type="submit" class="button default">Загрузить</button>
              </form>
            </div>
          {% endfor %}
          {% for item in documents_overview.additional %}
            <div class="application-document-card">
              <div class="application-document-card__header">
                <div>
                  <p class="application-document-card__title">{{ item.label }}</p>
                  {% if item.filename %}
                    <div class="application-document-card__filename">{{ item.filename }}</div>
                  {% endif %}
                </div>
                <span class="application-document-card__status {{ item.status_class }}">{{ item.status_label }}</span>
              </div>
              <div class="application-document-card__actions">
                {% if item.download_url %}
                  <a class="button" href="{{ item.download_url }}" target="_blank" rel="noopener">Скачать</a>
                {% endif %}
                {% if item.change_url %}
                  <a class="button" href="{{ item.change_url }}" target="_blank">Открыть карточку</a>
                {% endif %}
                {% if item.versions_url %}
                  <a class="button" href="{{ item.versions_url }}" target="_blank">Версии</a>
                {% endif %}
              </div>
              <form method="post" action="{{ documents_upload_url }}" enctype="multipart/form-data" class="application-document-card__form">
                {% csrf_token %}
                {% if item.document_id %}
                  <input type="hidden" name="document_id" value="{{ item.document_id }}">
                {% endif %}
                <input type="hidden" name="title" value="{{ item.label }}">
                <input type="file" name="document_file" required>
                <button type="submit" class="button default">Загрузить новую версию</button>
              </form>
            </div>
          {% endfor %}
          <div class="application-document-card application-document-card--new">
            <div class="application-document-card__header">
              <p class="application-document-card__title">Добавить произвольный документ</p>
            </div>
            <form method="post" action="{{ documents_upload_url }}" enctype="multipart/form-data" class="application-document-card__form">
              {% csrf_token %}
              <input type="text" name="title" placeholder="Название документа" class="vTextField" required>
              <input type="file" name="document_file" required>
              <button type="submit" class="button default">Загрузить</button>
            </form>
          </div>
        </div>
      </section>
    {% endif %}
    {% if comment_form %}
      <section id="comments" class="application-section">
        <h2>Комментарии</h2>
        <form method="post" action="{{ comment_form_action }}" class="application-comment-form">
          {% csrf_token %}
          {{ comment_form.non_field_errors }}
          <div class="fieldBox">
            {{ comment_form.comment.label_tag }}
            {{ comment_form.comment.errors }}
            {{ comment_form.comment }}
          </div>
          <div class="application-comment-form__actions">
            <label>
              {{ comment_form.is_urgent }} {{ comment_form.is_urgent.label }}
            </label>
            <button type="submit" name="submit_comment" class="button default">Добавить комментарий</button>
          </div>
        </form>
        {% if comment_feed %}
          <ul class="application-comment-list">
            {% for item in comment_feed %}
              <li class="application-comment-list__item{% if item.is_urgent %} application-comment-list__item--urgent{% endif %}">
                <div class="meta">
                  <span class="author">{{ item.author|default:"Без автора" }}</span>
                  <span class="time">{{ item.created_at|date:"d.m.Y H:i" }}</span>
                  {% if item.is_urgent %}<span class="tag">Срочно</span>{% endif %}
                </div>
                <div class="text">{{ item.text|linebreaksbr }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="application-comment-list__empty">Комментариев пока нет.</p>
        {% endif %}
      </section>
    {% endif %}
    {% if status_timeline %}
      <section class="application-section">
        <h2>История статусов</h2>
        <ul class="application-status-timeline">
          {% for item in status_timeline %}
            <li class="application-status-timeline__item">
              <div class="application-status-timeline__time">{{ item.created_at|date:"d.m.Y H:i" }}</div>
              <div class="application-status-timeline__content">
                <div class="application-status-timeline__transition">{{ item.old_label }} &rarr; {{ item.new_label }}</div>
                {% if item.changed_by %}
                  <div class="application-status-timeline__user">{{ item.changed_by }}</div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      </section>
    {% endif %}
  </div>
{% endblock %}
