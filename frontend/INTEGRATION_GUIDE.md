# Frontend Integration Guide

Этот документ помогает фронтенд-команде интегрироваться с динамической анкетой.

## Общие принципы
- Все публичные эндпоинты находятся под `/api/v1/applications/`.
- Аутентификация не требуется, state хранится в http-only cookie `session_token` плюс `public_id` заявки.
- Формы динамические: шаги, вопросы и условия приходят с бэкенда — не хардкодим структуру на фронте.

## Жизненный цикл анкеты
1. **Создание сессии**
   - `POST /api/v1/applications/forms/{survey_code}/sessions/`
   - В ответе: `public_id`, `current_step` (первый шаг), `answers` (пустой словарь).
   - Бэкенд выставляет cookie `session_token` (httponly, samesite=Lax). Фронт его не читает, просто использует `public_id` в последующих запросах.

2. **Загрузка черновика**
   - `GET /api/v1/applications/{public_id}/draft/`
   - Возвращает актуальный шаг и уже сохранённые ответы. Полезно для восстановлений сессии.

3. **Сохранение черновика**
   - `PATCH /api/v1/applications/{public_id}/draft/patch/`
   - Тело:
     ```json
     {
       "answers": [
         {"question_code": "phone", "value": "+7..."},
         {"question_code": "birth_date", "value": "2001-01-01"}
       ],
       "step_code": "personal"  // необязательно
     }
     ```
   - В ответе приходит актуальное состояние черновика. Если указать `step_code`, сервер переключит текущий шаг (используется, когда пользователь вручную перемещается).

4. **Переход к следующему шагу**
   - `POST /api/v1/applications/{public_id}/next/`
   - Можно отправить тело как у PATCH (сервер сохранит ответы перед вычислением следующего шага).
   - В ответе `current_step` смещается на следующий шаг или `null`, если анкета закончилась.

5. **Отправка анкеты**
   - `POST /api/v1/applications/{public_id}/submit/`
   - По желанию передаём последние ответы.
   - При успехе → `{ "public_id": "...", "status": "submitted" }`.
   - При ошибках → `400` с полями `errors` (массив {question, message}) и `document_errors`.

## Структура данных
- `current_step` → объект шага: `id`, `code`, `title`, `order`, `questions`.
- `questions` → массив вопросов. Типы (`type`): `text`, `number`, `date`, `select_one`, `select_many`, `yes_no`, `file`.
- `options` присутствуют только у select/yes_no вопросов.
- `payload` — свободный JSON для отображения (маски, плейсхолдеры и т.п.).
- `answers` → словарь `{question_code: value}`. Визуализация зависит от `type` и `payload`.

## Условия показа и навигация
- Бэкенд сам фильтрует вопросы по условиям (`Condition`). Фронтенду не нужно выполнять логику видимости — достаточно отрисовать полученный `current_step.questions`.
- Для навигации по шагам используем `POST /next/`. Если сервер вернул `null`, значит форма завершена.

## Сценарии ошибок
- Неизвестный `question_code` → `400` с ошибкой `"message": "Неизвестный код вопроса."`.
- Обязательные поля → `400` с массивом `errors`; показываем ошибки рядом с вопросами по `question`.
- Валидация документов пока заглушка (`document_errors` пустой массив).

## Практические рекомендации
- После каждого сохранения обновляйте локальное состояние фронтенда данными ответа — сервер мог убрать вопросы по условиям.
- Значения `select_many` ожидаются массивом строк; `yes_no` → булево; `file` → дескриптор файла (будет уточнено после подключения хранилища).
- Для автосейва используйте `PATCH /draft/patch/` с теми же полями, что пользователь изменил.
- Если пользователь вручную выбрал другой шаг (например, в прогресс-баре), сначала сохраните текущие ответы, затем вызовите `PATCH ... step_code`, чтобы синхронизировать прогресс.

## Что ещё появится позже
- Инструкция по загрузке документов и документальные требования (`document_errors`).
- Отправка ссылок на продолжение (email/SMS).
- Админские эндпоинты для просмотра заявок.

По всем вопросам обращайтесь к команде backend (`applications/services/form_runtime.py`).
